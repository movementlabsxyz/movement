version: "3"

processes:

  build:
    command: |
      exit 0

  setup:
    command: |
      exit 0
    depends_on:
      build:
        condition: process_completed_successfully

  celestia-light-node:
    command: |
      exit 1
    depends_on:
      setup:
        condition: process_completed_successfully

  celestia-light-node-synced:
    command: |
      wait-for-celestia-light-node
    depends_on:
      celestia-light-node:
        condition: process_healthy

  m1-da-light-node:
    command: |
      m1-da-light-node
    depends_on:
      celestia-light-node:
        condition: process_healthy
      celestia-light-node-synced:
        condition: process_completed_successfully
    readiness_probe:
      initial_delay_seconds: 3
      exec:
        command: echo "true"
    liveness_probe:
      initial_delay_seconds: 3
      exec:
        command: echo "true"

  postgres:
    command: |
      ./scripts/postgres/start-dev

    readiness_probe:
      initial_delay_seconds: 10
      exec:
        command: echo "true"
    
  suzuka-full-node:
    command: |
      RUST_LOG=trace suzuka-full-node
    depends_on:
      m1-da-light-node:
        condition: process_healthy
      postgres:
        condition: process_healthy
    readiness_probe:
      initial_delay_seconds: 10
      exec:
        command: echo "true"

  suzuka-faucet:
  
    command : |
      suzuka-faucet-service run-simple
    depends_on:
      suzuka-full-node:
        condition: process_healthy
    readiness_probe:
      initial_delay_seconds: 10
      exec:
        command: echo "true"

  suzuka-indexer-processor:
  
    command : |
      # todo: this fails with gRPC Unimplemented error on the RawData.GetTransactions call
      # RUST_LOG=debug suzuka-indexer-processor
      # for now, we will just prove the service is running with a grpcurl call
      # we will check the output
      RESPONSE=$(grpcurl -plaintext 0.0.0.0:30734 list aptos.indexer.v1.RawData)
      EXPECTED="aptos.indexer.v1.RawData.GetTransactions"
      if [[ "$RESPONSE" == "$EXPECTED" ]]; then
        exit 0
      else
        exit 1
      fi
    depends_on:
      suzuka-full-node:
        condition: process_healthy
    readiness_probe:
      initial_delay_seconds: 30
      exec:
        command: echo "true"

