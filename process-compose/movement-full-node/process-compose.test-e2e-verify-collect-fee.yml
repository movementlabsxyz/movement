version: "3"

processes:

  setup:
    environment:
      - "KNOWN_FRAMEWORK_RELEASE=biarritz-rc1"
      - APTOS_ACCOUNT_WHITELIST=$DOT_MOVEMENT_PATH/default_signer_address_whitelist
      - MAPTOS_PRIVATE_KEY=random

  framework-upgrade:
    command: |
      set -e
      RUST_LOG=info RUST_BACKTRACE=1 cargo run --bin aptos-framework-pre-l1-merge-release-tool
    depends_on:
      movement-full-node:
        condition: process_healthy
      movement-faucet:
        condition: process_healthy
    availability:
      exit_on_end: false
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    tty: true
    stdin_open: true

  test-e2e-verify-collect-fee:
    command: |
      set -e
      RUST_LOG=info RUST_BACKTRACE=1 cargo run --bin e2e_ggp_deprecation
    depends_on:
      movement-full-node:
        condition: process_healthy
      movement-faucet:
        condition: process_healthy
      framework-upgrade:
        condition: process_completed_successfully
    availability:
      exit_on_end: false
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    tty: true
    stdin_open: true
