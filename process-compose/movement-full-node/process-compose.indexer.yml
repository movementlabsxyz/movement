version: "3"

processes:

  build-indexer:
    command: |
      ./scripts/services/indexer/build
    availability:
      restart: exit_on_failure
    depends_on:
      build:
        condition: process_completed_successfully

  postgres:
    command: |
      ./scripts/postgres/start-dev

    readiness_probe:
      initial_delay_seconds: 5
      exec:
        command: echo "true"
    
  migrate-indexer:
    command: |
      MIGRATE_ONLY=1 movement-indexer-service
    environment:
      - RUST_LOG=trace
    availability:
      restart: exit_on_failure
    depends_on:
      build-indexer:
        condition: process_completed_successfully
      postgres:
        condition: process_healthy
      movement-full-node:
        condition: process_healthy

  indexer:
    command: |
      movement-indexer-service
    readiness_probe:
      initial_delay_seconds: 10
      exec:
        command: curl http://0.0.0.0:8084
    depends_on:
      build-indexer:
        condition: process_completed_successfully
      postgres:
        condition: process_healthy
      movement-full-node:
        condition: process_healthy
      migrate-indexer:
        condition: process_completed_successfully
